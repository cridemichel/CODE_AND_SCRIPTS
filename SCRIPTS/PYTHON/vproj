#!/usr/local/bin/python3
#Session.vim is generated by Obsession plugin
#usage: go to the directory where you want to start a session
#or recover a session and type
#> aninst <-s|-sn|--servername NAME> <-S|-sf|--sessioname NAME> <-h> <optional_path>
import os, sys
# per avere i color va installato con pip il modulo ansicolors 
# > pip install ansicolors
from colors import red, green, blue
def print_help():
    print('vinst <-s|-sn|--servername NAME> <-S|-sf|--sessioname NAME> <-novi|--noviminfo> <-vifn|--viminfofilename NAME> <-h> <optional_path>')
    print('with option -sn you can provide an optional servername while')
    print('with option -sf you choose a file name for the session file different from the default Session.vim') 
    print('-novi: do not load .viminfo file in the dir of session file')
    print('-vifn NAME: set a viminfo custom filename')
    quit()
args=sys.argv
itargs=iter(args)
sfdef='Session.vim'
sf=sfdef 
cd=os.getcwd()
DEBUG=True
spath=cd
vims='mvim --servername '
sn=''
vifn='.viminfo'
localviminfo=True
del(args[0])
for a in itargs:
    if a=='-s' or a == '-sn' or a  == '--servername':
        sn=next(itargs)
    if a == '-S' or a == '-sf' or a == '--sessionname':
        sf=next(itargs)
    if a == '-h' or a =='--help':
        print_help()
    if a == '-novi' or a == '--noviminfo':
        localviminfo=False
    if a == '-vifn' or a == '--viminfofilename':
        vifn=next(itargs)
    else:
        spath = a 
spath=spath.strip('\n')
if spath[-1]=='/':
    spath=spath[:-1] #strip '/'
#extract dirname + basename 
bn, en = os.path.split(spath)
spath = spath+'/'
#if servername exists vim automatically creates a new one
if DEBUG:
    print('en=', en, ' bn=', bn)
if sn=='':
    sn = en
if spath=='':
    spath=cd
fpsf=spath+sf
if DEBUG:   
    print('fpsf=', fpsf)
Sopt=' -S '+sf
#start obession with custom session file name provided via command flag -sf
NSopt=' -c \':Obsession '
if sf != sfdef:
    NSopt = NSopt + sf 
else:
    NSopt = NSopt 
NSopt = NSopt + '\''
if DEBUG: 
    print('path=',os.getenv('HOME'))
    print('spath=',os.path.abspath(spath))
    print('vinfo=',vifn)
if vifn == '.viminfo' and os.path.abspath(spath)==os.getenv('HOME'):
    yn=input(red('I will overwrite .viminfo in your home dir, continue (y/N)? '))
    if yn != 'y':
        print(green('ok aborting...'))
        quit()
if localviminfo==True:
    #exop = ' -c \':set viminfo+=n'+os.getcwd()+'/'+vifn+'\''
    exop = ' -i '+os.path.abspath(spath)+'/'+vifn
    if DEBUG:
        print('local viminfo='+os.path.abspath(spath)+'/'+vifn)
else:
    exop = ''
if os.path.exists(fpsf):
    os.chdir(spath)
    if DEBUG:
        print('executing=', vims+sn+Sopt+exop)
    os.system(vims+sn+Sopt+exop)
    os.chdir(cd)
else:
    os.chdir(spath)
    if DEBUG:
        print('executing=', vims+sn+NSopt+exop)
    os.system(vims+sn+NSopt+exop)
    os.chdir(cd)
